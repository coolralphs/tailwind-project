{% extends "master.html" %}
{% load filters %}
{% load static %}
{% load leaflet_tags %}

{% block title %}
    Itinerary
{% endblock %}

{% block content %}

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css"> 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/monim67/django-flatpickr@2.0.0/src/django_flatpickr/static/django_flatpickr/js/django-flatpickr.js"></script>
    <script src="https://github.com/jerroydmoore/leaflet-button/blob/master/L.Control.Button.js"></script>
    {% leaflet_js %}
    {% leaflet_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <div class="container-padding">
        <div id="image-container"></div>
        {% comment %} <img id="place-image" style="width:100px; height:100px; object-fit:cover; object-position:center;"> {% endcomment %}
        <form id="form_update_itinerary" method="post" style="margin-bottom:10px;margin-top:10px;">
            {% csrf_token %}
            <input id="id_user_survey" name="user_survey" value="{{ user_survey_id }}" hidden>
            <div class="nowrap-container">
                {{ form_update_itinerary.name }}
                <div class="buttons-right">
                    <button class="btn-activity-create btn-round-black" type="button" id="btn_itinerary_edit">
                        <i class="fas fa-pencil"></i>
                    </button>
                    <button class="btn-activity-create btn-round-success" type="submit" id="btn_itinerary_save" name="btn_itinerary_save" hidden>
                        <i class="fas fa-pencil" style="color:#198754;"></i>
                    </button>
                    <button id="btn_map" class="btn-round-black" type="button">
                        <i class="fas fa-map-location-dot" style="color:black;"></i> 
                    </button>
                    {% comment %} <button class="btn btn-outline-primary btn-activity-create btn-round-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                        <i class="fas fa-plus"></i> 
                    </button> {% endcomment %}
                </div>
            </div>
        </form>    
    </div>  

    <div class="slide active" id="map"></div>

    <div class="container-padding">
        <div class="nowrap-container">
            <div class="icon-input">
                <input id="h-osm-key" hidden/>
                <input id="h-osm-value" hidden/>
                <input id="h-house-number" hidden/>
                <input id="h-street" hidden/>
                <input id="h-city" hidden/>
                <input id="h-state" hidden/>
                <input id="h-postal-code" hidden/>
                <input id="h-country" hidden/>
                <input id="h-latitude" hidden/>
                <input id="h-longitude" hidden/>
                <input class="form-control place-input" type="search" id="place-input" placeholder="Search a place" autocomplete="off"/>
                <button type="button" id="clear-btn">&times;</button>
                <i class="fas fa-magnifying-glass"></i> 
            </div>
            <div class="buttons-right">
                <button class="btn-round-success-color" type="button" id="btn_add_activity" style="display: none;">
                    <i class="fas fa-plus" style="color: white;"></i>
                </button>                    
            </div>
            
        </div>
        
        <div id="suggestions"></div>
    </div>
    <div id="place-input-message" class="container-center" style="display: none;">
        <label class="text-danger">** Not saved yet. Click the add (+) button to save.</label>
    </div>
    {% comment %} <div id="search-container">
        <i class="fas fa-location-dot" style="margin-right:2px;"></i><input type="text" id="place-input" placeholder="Add a place" />
        <div id="suggestions"></div>
    </div> {% endcomment %}

    {% comment %} <a class="mt-3" href="{% url 'add_itinerary_destination' itinerary_id=itinerary_id %}"> Add Destination</a> |
    <a href="{% url 'update_itinerary' pk=itinerary_id %}"> Edit</a> {% endcomment %}
    {% if grouped_dates %}        
        <div class="accordion next-line" id="accordion" style="margin-top:10px;">    
            {% for date, activities in grouped_dates.items %}   
                <div class="accordion-item">                    
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ date|date:"m-d-Y" }}" aria-expanded="true" aria-controls="collapse{{forloop.counter}}">
                            <div>{{ date }} - {{ date|date:"l" }}</div>
                        </button>
                    </h2>
                    <div id="collapse_{{ date|date:"m-d-Y" }}" name="{{ date|date:"m-d-Y" }}" class="accordion-collapse collapse" data-bs-parent="#accordion">
                        <div class="">           
                            
                            {% comment %} <button class="btn btn-outline-primary btn-round-primary btn-activity-create btn-round activity-exising-date mt-2" name="{{ date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                <i class="fas fa-plus"></i> 
                            </button> {% endcomment %}

                            <div class="next-line" style="overflow-x:auto;">
                                <table class="">
                                    <thead class="table-head">
                                        <th>Time</th>
                                        <th></th>
                                        <th class="text-ellipsis">Activity</th>
                                        {% comment %} <th class="narrow-hidden">City</th> {% endcomment %}
                                        <th class="narrow-hidden td-center">Booked</th>
                                        <th class="narrow-hidden td-center">Paid</th>
                                        <th class="right-cell"></th>
                                        {% comment %} <th class="right-cell"></th> {% endcomment %}
                                        {% comment %} <th class="right-cell">
                                            <button class="btn btn-round-success-color btn-activity-create btn-round activity-exising-date" name="{{ date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                <i class="fas fa-plus" style="color:white;"></i> 
                                            </button>
                                        </th> {% endcomment %}
                                    </thead>
                                    <tbody>
                                        {% for i in activities|dictsort:"start_time" %}
                                            {% for key, val in i|get_fields %}
                                                {% comment %} {% if key != 'activity' %}
                                                <input class="activity-update-input-{{i.id}}" name="id_{{ key }}" value="" hidden/>
                                                {% else %} {% endcomment %}
                                                <input class="activity-update-input-{{i.id}}" name="id_{{ key }}" value="{{ val }}" hidden/>
                                                {% comment %} {% endif %} {% endcomment %}
                                            {% endfor %}
                                            <tr>   
                                                <td class="time-highlight fit-text-cell">{{ i.start_time|date:"g:i A" }}</td>

                                                <td class="icon-cell">
                                                    {% if i.osm_key %} 
                                                        {% if i.osm_key == 'tourism' %} 
                                                            <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i> 
                                                        {% comment %} {% elif %}
                                                            <i class="fas fa-car" style="text-shadow: 0px 0px 3px black; color: white;"></i>
                                                        {% else %}
                                                            <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i> {% endcomment %}
                                                        {% endif %}
                                                    {% endif %}
                                                </td>

                                                <td class="text-ellipsis">
                                                    {% comment %} {{ i.place_name }}   {% endcomment %}
                                                    {% comment %} <button class="btn btn-outline-primary btn-activity-update" name="{{i.id}}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                        Update
                                                    </button>  {% endcomment %}
                                                    <a class="btn-activity-update" style="color: blue;" name="{{i.id}}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                        {{ i.place_name }}  
                                                    </a>
                                                    {% comment %} <p> 
                                                    <i class="fas fa-trash-can" style="text-shadow: 0px 0px 3px red; color: white;float: right;"></i> 
                                                    </p> {% endcomment %}
                                                </td>

                                                <td class="td-center narrow-hidden right-cell">
                                                    {% if i.booking_required %} 
                                                        {% if i.is_booked %}
                                                            <i class="bi bi-check-circle" style="color:green;"></i> 
                                                        {% else %}
                                                            <i class="bi bi-x-circle-fill" style="color:red;"></i> 
                                                        {% endif %}
                                                    {% else %}
                                                        {% if i.is_booked %}
                                                            <i class="bi bi-check-circle" style="color:green;"></i> 
                                                        {% endif %}
                                                    {% endif %}
                                                </td>

                                                <td class="td-center narrow-hidden right-cell">
                                                    {% if i.pre_payment_required %} 
                                                        {% if i.is_paid %} 
                                                            <i class="bi bi-check-circle" style="color:green;"></i> 
                                                        {% else %}                                                                
                                                            <i class="bi bi-x-circle-fill" style="color:red;"></i> 
                                                        {% endif %}
                                                    {% else %}
                                                        {% if i.is_paid %} 
                                                            <i class="bi bi-check-circle" style="color:green;"></i> 
                                                        {% endif %}
                                                    {% endif %}
                                                </td>

                                                <td class="td-center right-cell">
                                                    <img id="place-image-{{ i.id }}" class="item-image" alt="{{ i.place_name }}">
                                                </td>

                                                {% comment %} <td class="right-cell">
                                                    <i class="fas fa-ellipsis" style="color:gray;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight_Directions" aria-controls="offcanvasRight_Directions"></i> 
                                                </td> {% endcomment %}
                                            </tr>
                                            <tr>
                                                <td colspan="7" style="text-align: center;">
                                                    {% comment %} <button class="btn btn-outline-pill btn-sm"> 
                                                        <i class="fas fa-person-walking" style="color:gray;"></i>
                                                        <i class="fas fa-car" style="color:gray;"></i>
                                                        <i class="fas fa-plane" style="color:gray;"></i> &nbsp;
                                                        <i class="fas fa-caret-down" style="color:gray; size: 5px;"></i>
                                                    </button> {% endcomment %}

                                                     <button class="btn btn-outline-pill btn-sm"> 
                                                        <i class="fas fa-person-walking" style="color:gray; margin-left:3px;"></i> &nbsp;
                                                        <i class="fas fa-caret-down" style="color:gray; size: 5px;"></i> 
        
                                                    </button>
                                                    {% comment %} <button class="btn btn-outline-pill-transparent btn-sm">
                                                        <i class="fas fa-caret-down" style="color:gray; size: 5px;"></i>
                                                    </button> {% endcomment %}
                                                    
                                                    <button class="btn btn-outline-pill-right btn-sm options-ellipsis" name="{{i.id}}">
                                                        <i class="fas fa-ellipsis" style="color:gray;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight_Directions" aria-controls="offcanvasRight_Directions"></i> 
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}                                            
                                    </tbody>
                                </table>
                            </div>
                        </div> 
                    </div>
                </div>    
            {% endfor %}
        </div>            
    {% else %}
    <div class="accordion mt-2 container-padding">There are no destinations on this itinerary.</div>
    {% endif %}

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel">Add New Activity</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" style="margin-top:-20px;">
            <form method="post" >
                {% csrf_token %} 
                {{ form.media }}   
                {% comment %} {{ form.as_p }} {% endcomment %}
                
                {% for field in form %}
                    {% if not field.is_hidden %}
                        {% if field.name == 'house_number' %}
                            <label style="margin-bottom: -10px;">Address:</label>
                            <div class="accordion" id="addressAccordion" style="margin-top:10px;">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading_address">
                                        <button class="accordion-button collapsed accordion-button-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_address" aria-expanded="false" aria-controls="collapse_address">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </button>
                                    </h2>
                                    <div id="collapse_address" class="accordion-collapse collapse" aria-labelledby="heading_address" data-bs-parent="addressAccordion">
                                        <div class="accordion-body" style="margin-top:-10px;">
                                            {{ field.label_tag }}
                                            {{ field }}
                                            {% if field.errors %}
                                                <div class="errorlist">
                                                    {{ field.errors }}
                                                </div>
                                            {% endif %}
                        {% elif field.name == 'start_date' %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% elif field.name in address_field_list %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% else %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
                {% comment %} {% include 'itinerary_item.html' %} {% endcomment %}

                <input id="id_itinerary" name="itinerary" value="{{ itinerary_id }}" hidden>
                <div style="display: flex; margin-top:10px;">
                    <button name="form_submit" class="btn btn-success btn-sm" type="submit" style="width:100%;">Save</button>
                    <button id="id_remove_marker" class="btn btn-danger btn-sm" style="display: none;">Remove</button>
                </div>
            </form>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight_Directions" aria-labelledby="offcanvasRightLabel_Directions">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel_Directions">Options:</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <button class="open-map btn btn-outline-primary" type="button">
                Google Maps
            </button>
            <button class="open-google btn btn-outline-primary" type="button">
                Google Search
            </button>
        </div>
    </div>

    <div id="scroll-up">
        <i class="fa-solid fa-angles-up"></i>
    </div>

    <div id="divImageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="idImageModal">
        <div id="caption"></div>
    </div>

    {% comment %} <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight_Destination" aria-labelledby="offcanvasRightLabel_Destination">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel_Destination">Add New Destination</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form method="post" class="small-form-width">
                {% csrf_token %}

                <label>Country:</label>

                <div>
                    <label><input type="radio" id="existing" name="country_selection" value="existing" checked /> Existing</label>
                </div>
                <div>
                    <label><input type="radio" id="new" name="country_selection" value="new" /> New</label>
                </div>

                {{ form_destination.media }}
                {{ form_destination.as_p }}
                <input id="id_itinerary" name="itinerary" value="{{ itinerary_id }}" hidden>
                
                <button class="btn btn-success btn-sm" type="submit">Add</button>
                    </form>
                </div>
    </div> {% endcomment %}

    <script>      

        $(window).scroll(function() {
            if($(this).scrollTop() != 0) {
                $('#scroll-up').fadeIn(); 
            } else {
                $('#scroll-up').fadeOut();
            }
        });

        $('#scroll-up').click(function() {
            $('body,html').animate({scrollTop:0},"fast");
        });       



        var offcanvas = new bootstrap.Offcanvas($('#offcanvasRight'));

        const markerIcon = L.icon({
            iconUrl: "{% static 'leaflet/images/marker-icon.png' %}",
            shadowUrl: "{% static 'leaflet/images/marker-shadow.png' %}",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
        var map = L.map('map');
        var markers = [];
        L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: ' <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);              

        var bounds = L.latLngBounds(); 

        var locations = [];
        {% for date, activities in grouped_dates.items %}
            {% for i in activities|dictsort:"start_time" %}
                locations.push(["{{ i.city }}", "{{ i.postal_code }}", "{{ i.state }}", "{{ i.country }}", "{{ i.place_name }}", "{{ i.latitude }}", "{{ i.longitude }}", "{{ i.id }}"]);
                //console.log("{{ i.id }}");
            {% endfor %}
        {% endfor %}
       
        for (var i = 0; i < locations.length; i++) {
            //console.log(locations[i][7]);
            var name = locations[i][4].replace(/\s/g, "+");
            var city = locations[i][0].replace(/\s/g, "+");
            var city_comma = '';
            var state = locations[i][2].replace(/\s/g, "+");
            console.log(locations[i][2]);
            var state_comma = '';
            var zip = locations[i][1].replace(/\s/g, "+");
            var country = locations[i][3].replace(/\s/g, "+");
            if (city.trim() != "") {
                city_comma = city + ',';
            }
            if (city.trim() === "None") {
                city_comma = '';
            }
            if (state.trim() != "") {
                state_comma = state + ',';
            }
            if (state.trim() === "None") {
                state_comma = '';
            }
            var fullAddress = `${name},+${city_comma},+${state_comma}+${zip}`;
            
            bounds.extend(L.latLng([locations[i][5], locations[i][6]])); 
            marker = new L.marker([locations[i][5], locations[i][6]], { icon: markerIcon }) //{draggable:'true'}
            .bindPopup(`<b>${locations[i][4]}</b>
                <br>${city_comma} ${state_comma} ${locations[i][3]}
                <br><a href="#">Edit</a> | <a href="https://www.google.com/maps/dir/?api=1&destination=${fullAddress}" target="_blank">Directions</a>
                `)
            .addTo(map);
            markers.push(marker);

            //marker.on("dragend", function(e) {
            //    var marker = e.target;
            //    var position = marker.getLatLng();
            //    map.panTo(new L.LatLng(position.lat, position.lng));
            //    console.log(position.lat);
             //   console.log(position.lng);

            //    //TO DO: UPDATE COORDINATES IN DB

            //});
        }

        try{
            var center = bounds.getCenter();
            map.setView(center, 10);
            map.fitBounds(bounds);
        }
        catch(e) {
            var center = {{ map_center }}; 
            console.log(center);
            map.setView([37.092, -95.7129], 3);
        }
    
        var distinctFlags = [];
        var distinctFlagUrls = [];

        $.when( setDistinctFlags() )
            .then( func2 )
            .then( func3 )
            .catch(function(error) {
                console.error("An error occurred:", error);
        });

        function setDistinctFlags() {
            for (var i = 0; i < locations.length; i++) {
                distinctFlags = addIfNotExist(distinctFlags, locations[i], 3);
            }
            return $.Deferred().resolve().promise();            
        }

        function func2() {
            let apiUrl = "https://commons.wikimedia.org/w/api.php";

            const emUsr = "coolralph_s";
            const emDmn = "hotmail.com"
            const request = `TailwindTravel (${emUsr}@${emDmn})`;
            
            for (var i = 0; i < distinctFlags.length; i++) {
                let country = distinctFlags[i];
                let titleSearch = `File:Flag of ${country}.svg`;
                $.ajax({
                    url: apiUrl,
                    data: {
                        action: "query",
                        format: "json",
                        origin: "*",
                        titles: titleSearch,
                        prop: "imageinfo",
                        iiprop: "url"
                    },
                    dataType: "jsonp",
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('User-Agent', request);
                    },
                    success: function(data) {
                        let pages = data.query.pages;
                        
                        if (pages) {
                            let flagUrl = null;

                            // Loop through results to find the most relevant flag image
                            $.each(pages, function(index, page) {
                                if (page.imageinfo) {
                                    flagUrl = page.imageinfo[0].url;
                                    
                                    return false; // Exit loop after getting the first valid image
                                }
                            });

                            if (flagUrl) {
                                //console.log(country);
                                distinctFlagUrls.push([country, flagUrl]);
                                //console.log(flagUrl);
                            } else {
                                console.log("Flag not found.");
                            }
                        }
                    },
                    error: function(err) {
                        console.error('Error fetching data:', err);
                    }
                    
                });
            }
            return $.Deferred().resolve().promise();    
        }

        function fetchFlags() {
            console.log(distinctFlags);
            return $.Deferred(function(deferred) {     
                
                let ajaxCalls = [];
                for (var i = 0; i < distinctFlags.length; i++) {

                    let apiUrl = "https://commons.wikimedia.org/w/api.php";
                    let titleSearch = `File:Flag of ${distinctFlags[i]}.svg`;

                    const emUsr = "coolralph_s";
                    const emDmn = "hotmail.com"
                    const request = `TailwindTravel (${emUsr}@${emDmn})`;
                    
                    ajaxCalls.push(
                        $.ajax({
                            url: apiUrl,
                            data: {
                                action: "query",
                                format: "json",
                                origin: "*",
                                titles: titleSearch,
                                prop: "imageinfo",
                                iiprop: "url"
                            },
                            dataType: "jsonp",
                            beforeSend: function(xhr) {
                                xhr.setRequestHeader('User-Agent', request);
                            },
                            success: function(data) {
                                let pages = data.query.pages;
                                
                                if (pages) {
                                    let flagUrl = null;

                                    // Loop through results to find the most relevant flag image
                                    $.each(pages, function(index, page) {
                                        if (page.imageinfo) {
                                            flagUrl = page.imageinfo[0].url;
                                            
                                            return false; // Exit loop after getting the first valid image
                                        }
                                    });

                                    if (flagUrl) {
                                        //distinctFlagUrls.push([distinctFlags[i], flagUrl]);
                                        console.log(flagUrl);
                                    } else {
                                        console.log("Flag not found.");
                                    }
                                }
                            },
                            error: function(err) {
                                console.error('Error fetching data:', err);
                            }
                            
                        })
                    );
                    
                }
                $.when(...ajaxCalls).done(() => {
                    console.log('second func done');
                    deferred.resolve();
                });

            }).promise();            
        }

        function func3() {

            for (var i = 0; i < locations.length; i++) {
                fetchImageForLocation(locations[i]);  
            }
            return $.Deferred().resolve().promise();            
        }
        
        
        //for (var i = 0; i < locations.length; i++) {
        //    distinctFlags = addIfNotExist(distinctFlags, locations[i], 3);
        //}
        
        //for (var i = 0; i < distinctFlags.length; i++) {
        //    //console.log(distinctFlags[i]);
        //    fetchFlags(distinctFlags[i]);
        //}
        function addIfNotExist(array, item, fieldIndex) {
            // Check if the item exists in the array based on the specified field
            findCountry = item[fieldIndex];
            const countryExists = array.some(country => country === findCountry);
            // If the item doesn't exist, add it to the array
            if (countryExists == false) {
                array.push(item[fieldIndex]);
            }

            return array;
        }

        //for (var i = 0; i < fetchFlags.length; i++) {
        //    console.log(fetchFlags[i]);
        //}

        //for (var i = 0; i < locations.length; i++) {
        //    fetchImageForLocation(locations[i]);
        //}
        
        function fetchFlags(location) {
            //const flagApiUrl = `https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrsearch=${encodeURIComponent(flagSearch)}&gsrlimit=5&prop=imageinfo&iiprop=url`;

            
        }

        function fetchImageForLocation(location) {
            //const placeName = "Eiffel Tower";

            var locationId = location[7];
            var placeName = location[4];

            const wikiUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(placeName)}&prop=pageimages&format=json&pithumbsize=500&origin=*`;

            //$.getJSON(wikiUrl, function (data) {
            //    const objects = data.features;
            //});
            
            const emUsr = "coolralph_s";
            const emDmn = "hotmail.com"
            const request = `TailwindTravel (${emUsr}@${emDmn})`;

            $.ajax({
                url: wikiUrl,
                data: {
                    action: "query",
                    format: "json",
                    origin: "*",
                    titles: `${encodeURIComponent(placeName)}`,
                    prop: "pageimages",
                    pithumbsize: "500"
                },
                dataType: "jsonp",
                method: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('User-Agent', request);
                },
                success: function(response) {
                    const pages = response.query.pages;
                    for (const pageId in pages) {
                        const page = pages[pageId];
                        if (page.thumbnail) {
                            const imageUrl = page.thumbnail.source;
                            $("#place-image-" + locationId).attr('src', imageUrl);
                        } else {
                            console.log('No image found for this place.');
                            try {
                                //console.log(location[3]);
                                //console.log(distinctFlagUrls);
                                var result = distinctFlagUrls.filter(item => item[0] === location[3]);
                                console.log(result[0][1]);
                                $("#place-image-" + locationId).attr('src', result[0][1]);
                            }
                            catch (ex) {
                                console.log('No flag found for this place either.');
                            }
                        }
                    }
                },
                error: function(err) {
                    console.error('Error fetching data:', err);
                }
            });
        }

        let searchMarker; // To store the marker

        // Search and handle results
        $('#place-input').on('input', function () {
        const query = $(this).val();
        if (query.length < 3) {
            $('#suggestions').empty();
            return;
        }

        // Photon API URL
        const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`;

        // AJAX request to Photon API
        $.getJSON(url, function (data) {
            const features = data.features;
            $('#suggestions').empty(); // Clear old suggestions

            if (features.length === 0) {
            $('#suggestions').append('<div>No results found.</div>');
            return;
            }
            
            featuresAdded = [];

            features.forEach(function (feature) {
                if (placeInputIsEmpty) {
                    return false;
                }
                var name = feature.properties.name || 'Unnamed location';

                var house_number = '';
                try {
                    house_number = feature.properties.housenumber || '';
                }
                catch (e)
                {

                }
                var street = feature.properties.street || '';
                var city = feature.properties.city || '';
                var city_comma = '';
                var state = feature.properties.state || '';
                var state_comma = '';
                var postal_code = feature.properties.postcode || '';
                var country = feature.properties.country || '';

                if (city.trim() != "") {
                    city_comma = city + ',';
                }
                if (state.trim() != "") {
                    state_comma = state + ',';
                }

                var osm_key  = '';
                try {
                    osm_key = feature.properties.osm_key || '';
                }
                catch (e)
                {

                }
                var osm_value  = '';
                try {
                    osm_value = feature.properties.osm_value || '';
                }
                catch (e)
                {

                }
                
                var latitude = feature.geometry.coordinates[1];
                var longitude = feature.geometry.coordinates[0];
                
                //const fullAddress = $(`${name}, ${city}, ${country}`);

                //console.log(fullAddress);
                //if (featuresAdded.includes(fullAddress))
                //{
                //    return true;
               //}

                const suggestion = $(`<div class="suggestion"><i class="fas fa-location-dot" ></i> ${name}, ${city_comma} ${state_comma} ${country}</div>`);
                
                // On click, update the map and input field
                suggestion.on('click', function () {
                    //console.log(feature);
                    //mapDiv.classList.toggle('active');
                    //$('#place-input').val(`${name}, ${city} ${country}`);
                    $('#suggestions').empty(); // Clear suggestions
    
                    //fullValue = `${name}, ${city} ${state} ${country}`;
                    // Center the map and add a marker
                    if (searchMarker) map.removeLayer(searchMarker);
                    map.setView([latitude, longitude], 15);
                    searchMarker = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup(`<b>${name}</b><br>${city_comma} ${state_comma} ${country}`)
                        .openPopup();
                    //markers.push(searchMarker);
                    var h_place_name = document.getElementById('place-input');
                    var h_osm_key = document.getElementById('h-osm-key');
                    var h_osm_value = document.getElementById('h-osm-value');
                    var h_house_number = document.getElementById('h-house-number');
                    var h_street = document.getElementById('h-street');
                    var h_city = document.getElementById('h-city');
                    var h_state = document.getElementById('h-state');
                    var h_postal_code = document.getElementById('h-postal-code');
                    var h_country = document.getElementById('h-country');
                    var h_latitude = document.getElementById('h-latitude');
                    var h_longitude = document.getElementById('h-longitude');
                    h_place_name.value = name;
                    h_place_name.focus();
                    h_osm_key.value = osm_key;
                    h_osm_value.value = osm_value;
                    h_house_number.value = house_number;
                    h_street.value = street;
                    h_city.value = city;
                    h_state.value = state;
                    h_postal_code.value = postal_code;
                    h_country.value = country;
                    h_latitude.value = latitude;
                    h_longitude.value = longitude;
                    $("#place-input-message").show();
                    //offcanvas.show();                    
                });                

                let exists = false;
                featuresAdded.forEach(function (i) {
                    if (i === `${name}, ${city} ${country}`)
                    {
                        exists = true;
                    }
                });

                if (!exists)
                {
                    $('#suggestions').append(suggestion);
                    featuresAdded.push(`${name}, ${city} ${country}`);
                }

                });
            });
        });

        config_start_time = {
            altInput: true,
            enableTime: true,
            noCalendar: true,
            time_24hr: false,
            dateFormat: "H:i:S",
            defaultDate: "12:00"
        }
        config_end_time = {
            altInput: true,
            enableTime: true,
            noCalendar: true,
            time_24hr: false,
            dateFormat: "H:i:S",
            defaultDate: "13:00"
        }
        //initialize time inputs
        let st = flatpickr("#id_start_time", config_start_time);
        let et = flatpickr("#id_end_time", config_end_time); 

        let activity_array = [];

        $( function() {
            setTimeout(function () {
                window.dispatchEvent(new Event('resize'));
            }, 1000);
            $.ajaxSetup({
            headers: { "X-CSRFToken": '{{csrf_token}}' }
            });
            try {      
                //let inputString = $("#id_activity_array").val();
                //activity_array = JSON.parse(inputString);

                //initialize date pickers
                $( "#id_start_date" ).datepicker({
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true
                });
                $( "#id_end_date" ).datepicker({
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true
                });

                //make sure date is a real date and exists
                try {
                    //expand if passed
                    var expand_date = $("#id_expand_item").val();
                    $("#collapse_"+expand_date).collapse("show");  
                    var date = $("#collapse_"+expand_date).attr('name');

                    var parts = date.split('-');
                    var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
                    $('#id_start_date').datepicker("setDate", dateObj);
                    $('#id_end_date').datepicker("setDate", dateObj);
                }
                catch (error)
                {
                    $('#id_start_date').datepicker("setDate", "today");
                    $('#id_end_date').datepicker("setDate", "today");
                }

                //code for create activity
                //$("#id_country").hide();
                //$("#id_city").hide();
                //$("label[for='id_country']").css("margin-top", "10px");
                //$("label[for='id_city']").css("margin-top", "10px");
                //$("label[for='id_itinerary_destination']").css("margin-top", "10px");
                //$("label[for='id_country']").hide();                                                                                 
            }
            catch (error)
            {
                console.log(error)
            }
        } );
        $('#accordion').on('show.bs.collapse', function (e) {
            var date = e.target.getAttribute('name');
            SetDatePickers(date);
            SetExpandItem(date);
        });        
        function SetDatePickers(date){
            var parts = date.split('-');
            var dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
            $('#id_start_date').datepicker("setDate", dateObj);
            $('#id_end_date').datepicker("setDate", dateObj);
        }
        function SetExpandItem(date){
            $("#id_expand_item").val(date);
        }
        $('input[type="radio"]').change(function() {
            var selectedValue = $(this).val();
            //console.log(selectedValue);
            if (selectedValue == 'existing')
            {
                $("#id_country").hide();
                $("#id_city").hide();
                $("label[for='id_country']").hide();
                $("label[for='id_city']").hide();
                //$("label[for='id_itinerary_destination']").show();
                //$("#id_itinerary_destination").show();
                //$("#id_itinerary_destination").prop('required',true);
                $("#id_country").prop('required',false);
                $("#id_city").prop('required',false);
            }
            else{
                $("#id_country").show();
                $("#id_city").show();
                $("label[for='id_country']").show();
                $("label[for='id_city']").show();
                //$("label[for='id_itinerary_destination']").hide();
                //$("#id_itinerary_destination").hide();
                //$("#id_itinerary_destination").prop('required',false);
                $("#id_country").prop('required',true);
                $("#id_city").prop('required',true);
            }            
        });
        $("#id_existing_countries").change(function() {
            var selectedValue = $(this).val(); 
            $("#id_country").val(selectedValue).change();   
        });

        $("#btn_itinerary_edit").click(function() {
            $(this).attr("hidden", true);       
            $("#btn_itinerary_save").removeAttr('hidden');

            $("#id_name").prop("disabled", false);
            $("#id_name").focus();
        });

        $("#form_update_itinerary").submit(function(event) {
            event.preventDefault(); // Prevent default form submission

            $.ajax({
                url: $(this).attr("action"),
                type: $(this).attr("method"),
                data: $(this).serialize(),
            success: function(response) {
                //console.log(response.message);
                $("#btn_itinerary_save").attr("hidden", true);       
                $("#btn_itinerary_edit").removeAttr('hidden');
                $("#id_name").prop("disabled", true);
            },
            error: function(error) {
                console.error("Error submitting form:", error);
            }
            });
        });

        $("input").on("focus", function() {
            var input = $(this);
            if (input.attr("id") == "id_name")
            {
                //console.log(input.attr("id"));
                var len = input.val().length;

                // Set timeout to allow the focus to take effect first
                setTimeout(function() {
                input[0].setSelectionRange(len, len);
                }, 0);
            }
        });

        $(".btn-activity-update").click(function() {
            console.log('update clicked');
            var itinerary_item_id = $(this).attr('name');
            $("#id_operation").val('update');
            $("#offcanvasRightLabel").text("Update Activity");
            var inputs = $(".activity-update-input-" + itinerary_item_id);
            //set values
            for(var i = 0; i < inputs.length; i++){
                var val = $(inputs[i]).val();
                var name = $(inputs[i]).attr('name');

                if (val === 'None')
                {
                    val = '';
                }
                
                switch(name) {
                case "id_start_date":
                case "id_end_date":
                    var date_parts = val.split('-');
                    var newDateObj = new Date(date_parts[0], date_parts[1] - 1, date_parts[2]); 
                    $('#'+name).datepicker("setDate", newDateObj);
                    break;
                case "id_start_time":
                    //console.log(val);
                    st.setDate(val)
                    break;
                case "id_end_time":        
                    et.setDate(val);
                    break;
                case "id_is_skip":                    
                case "id_is_booked":
                case "id_booking_required":
                case "id_pre_payment_required":
                case "id_is_paid":
                    var isTrueSet = (val.toLowerCase() === 'true');
                    $("#"+name).prop('checked', isTrueSet);
                    break;
                case "id_id":
                    //console.log(val);
                case "id_activity":
                    var selectedTypeId = $('#id_activity_type').find(":selected").val();
                    var select = $("#"+name);
                    select.empty();
                    $.each(activity_array, function(index, item) {                        
                        if (parseInt(item[0]) === parseInt(selectedTypeId)) {
                            select.append($("<option></option>")
                            .attr("value", item[1])
                            .text(item[2]));
                        }
                    });
                    select.val(val);
                    break;
                default:                   
                    $("#"+name).val(val);
                    break;
                }                
            }
        });
        $(".btn-activity-create").click(function() {
            $("#id_operation").val('create');
            $("#offcanvasRightLabel").text("Add New Activity");
            //empty activities
            $("#id_activity").empty();
            //deselect all selects
            $('select').each(function() {
                $(this).val(''); // Set the value to an empty string
            });
            //clear all updatable inputs
            $(".updatable:visible").each(function() {
                $(this).val("");
            });
            //unckeck all checkboxes
            $('input[type=checkbox]').each( 
                function (index, checkbox) { 
                if (index != 0) { 
                    checkbox.checked = false; 
                } 
            }); 
            //reinitialize dates/times
            st.setDate('12:00');
            et.setDate('13:00');
            if ($(this).hasClass("activity-exising-date")){
                //console.log($(this).attr('name'));
                var date = $(this).attr('name')
                var parts = date.split('-');
                var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
                $('#id_start_date').datepicker("setDate", dateObj);
                $('#id_end_date').datepicker("setDate", dateObj);
            }
            else
            {                
                $('#id_start_date').datepicker("setDate", "today");
                $('#id_end_date').datepicker("setDate", "today");
            }
        });
        $("#id_activity_type").change(function() {
            var selectedTypeId = $(this).val();
            var select = $("#id_activity");
            select.empty();
            $.each(activity_array, function(index, item) {                        
                if (parseInt(item[0]) === parseInt(selectedTypeId)) {
                    select.append($("<option></option>")
                        .attr("value", item[1])
                        .text(item[2]));
                }
            });
        });
        $('#id_start_date').change(function() {
            var selectedDate = $(this).val();
            var parts = selectedDate.split('/');
            var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
            $('#id_end_date').datepicker("setDate", dateObj);
        });

        var googleSearch = '';
        var directionsFullAddress = '';
        $(".options-ellipsis").click(function() {
            var itinerary_item_id = $(this).attr('name');
            var inputs = $(".activity-update-input-" + itinerary_item_id);

            var place = '';
            var city = '';
            var city_comma = '';
            var state = '';
            var state_comma = '';
            var zip = '';
            var country = '';

            //set values
            for(var i = 0; i < inputs.length; i++){
                var val = $(inputs[i]).val();
                var name = $(inputs[i]).attr('name');
                if (val === 'None')
                {
                    val = '';
                }
                
                switch(name) {
                case "id_place_name":
                    place = val;
                case "id_city":
                    city = val;
                    break;
                case "id_state":
                    state = val;
                    break;
                case "id_postal_code":
                    zip = val;
                    break;
                case "id_country":
                    country = val;
                    break;
                default:                   

                    break;
                }                
            }
            if (city.trim() != "") {
                city_comma = city + ',';
            }
            if (state.trim() != "") {
                state_comma = state + ',';
            }

            directionsFullAddress = `${place},+${city_comma},+${state_comma}+${zip}+${country}`;
            googleSearch = place;
        });

        $(".open-map").click(function() {
            //var street = "Zion Park Blvd.".replace(/\s/g, "+");
            //var city = "Springdale".replace(/\s/g, "+");
            //var state = "UT".replace(/\s/g, "+");
            //var zip = "84767";
            //var fullAddress = `${street},+${city},+${state}+${zip}`;
            console.log(directionsFullAddress);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${directionsFullAddress}`, "_blank");
        });
        $(".open-google").click(function() {
            var encodedSearch = encodeURIComponent(googleSearch);
            window.open(`https://www.google.com/search?q=${encodedSearch}`, "_blank");
        });
        $("#id_remove_marker").click(function() {
            map.removeLayer(searchMarker);

            //zoom-to-fit
            map.fitBounds(bounds);    

            //ajax delete from db if exists
            //close offcanvas
            offcanvas.hide();
        });
        const mapDiv = document.getElementById('map');
        $("#btn_map").click(function() {
            mapDiv.classList.toggle('active');
        });                              
        //$('input[type="search"]').on('search', function(e) {
        //    $('#suggestions').empty();
        //});
        let debounceTimeout;
        $('input[type="search"]').on('input', function() {
            if ($.trim($('#place-input').val()) != '') {
                placeInputIsEmpty = false;
                $("#btn_add_activity").show();
            }
            else {
                $("#btn_add_activity").hide();
            }
            checkAndClear();
        }).on('keyup', function(e) {
            if (e.key === 'Backspace' || e.keyCode === 8) {
                checkAndClear();
            }
            if (e.which === 13) {
                //enter was pressed
                $("#id_operation").val('create');
                setOffsetValues()
                offcanvas.show();
            }
        });
        let placeInputIsEmpty = false;
        function checkAndClear() {
            if ($.trim($('#place-input').val()) === '') {
                placeInputIsEmpty = true;
                $('#suggestions').empty();
            }
        }
        $('input[type="search"]').on('focus', function() {
            //$("html, body").animate({scrollTop:0}, 500);
        });
        $("#btn_add_activity").click(function() {
            $("#id_operation").val('create');
            setOffsetValues()
            offcanvas.show();
        });
        function setOffsetValues() {
            console.log($('#street').val());
            $("#id_place_name").val($('#place-input').val());
            $("#id_osm_key").val($('#h-osm-key').val());
            $("#id_osm_value").val($('#h-osm-value').val());
            $("#id_house_number").val($('#h-house-number').val());
            $("#id_street").val($('#h-street').val());
            $("#id_city").val($('#h-city').val());
            $("#id_state").val($('#h-state').val());
            $("#id_postal_code").val($('#h-postal-code').val());
            $("#id_country").val($('#h-country').val());
            $("#id_latitude").val($('#h-latitude').val());
            $("#id_longitude").val($('#h-longitude').val());
        }
        var myOffcanvas = document.getElementById('offcanvasRight');
        myOffcanvas.addEventListener('hidden.bs.offcanvas', function () {

        });

        const searchInput = document.getElementById('place-input');
        const clearButton = document.getElementById('clear-btn');

        // Show/hide clear button based on input value
        searchInput.addEventListener('input', () => {
            clearButton.style.display = searchInput.value ? 'block' : 'none';
        });

        // Clear the input when the clear button is clicked
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            clearButton.style.display = 'none';
            $('#suggestions').empty();
            $("#place-input-message").hide();
            searchInput.focus(); // Optional: return focus to the input
        });

        var modal = document.getElementById("divImageModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var modalImg = document.getElementById("idImageModal");
        var captionText = document.getElementById("caption");
        $(".item-image").click(function() {
            var src = $(this).attr("src");
            modal.style.display = "block";
            modalImg.src = src;
            captionText.innerHTML = this.alt;
        });
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
            modal.style.display = "none";
        }

        $("#divImageModal").click(function() {
            modal.style.display = "none";
        });

        L.Control.SimpleButton = L.Control.extend({
            _className: 'leaflet-control-simplebutton',
            options: {
                faIcon: 'fa-crosshairs',
                position: 'topright',
                text: "",
                id: "",
                click: function(){}
            },
            initialize: function (options) {
                L.setOptions(this, options);
            },
            onAdd: function (map) {
                this._map = map;
                this._container = L.DomUtil.create('div',this._className);
                this._buildButton();
                return this._container;
            },
            onRemove: function (map) {
                L.DomEvent.off(this._link, 'click', this.options.click);
            },
            _buildButton: function(){
                this._link = L.DomUtil.create('a','simplebutton-action',this._container);
                this._link.href = "#";
                if(this.options.id) {
                this._link.id = this.options.id;
                }
                if(this.options.text) {
                this._link.innerHTML = this.options.text;
                }else{
                L.DomUtil.create('i','fa ' + this.options.faIcon, this._link);
                }
                L.DomEvent.on(this._link, 'click', this.options.click, this._link);
            }
        });

        L.control.simplebutton = function (options) {
            return new L.Control.SimpleButton(options);
        };

        var button = new L.Control.SimpleButton({
            click: function(evt) {
                if (markers.length > 0) {

                        markers.forEach(function(marker, index) {
                            var latLng = marker.getLatLng();
                            console.log(latLng);
                            bounds.extend(L.latLng([latLng.lat, latLng.lng])); 
                        });
                        //var cntr = bounds.getCenter();
                        //map.setView(cntr, 10);
                        map.fitBounds(bounds);
                    }
            }
        });
        button.addTo(map);

        L.Control.SimpleButton = L.Control.extend({
            _className: 'leaflet-control-simplebutton',
            options: {
                faIcon: 'fa-angles-down',
                position: 'topright',
                text: "",
                id: "",
                click: function(){}
            },
            initialize: function (options) {
                L.setOptions(this, options);
            },
            onAdd: function (map) {
                this._map = map;
                this._container = L.DomUtil.create('div',this._className);
                this._buildButton();
                return this._container;
            },
            onRemove: function (map) {
                L.DomEvent.off(this._link, 'click', this.options.click);
            },
            _buildButton: function(){
                this._link = L.DomUtil.create('a','simplebutton-action',this._container);
                this._link.href = "#";
                if(this.options.id) {
                this._link.id = this.options.id;
                }
                if(this.options.text) {
                this._link.innerHTML = this.options.text;
                }else{
                L.DomUtil.create('i','fa ' + this.options.faIcon, this._link);
                }
                L.DomEvent.on(this._link, 'click', this.options.click, this._link);
            }
        });

        L.control.simplebutton = function (options) {
            return new L.Control.SimpleButton(options);
        };

        const targetElement = $("#accordion");
        var button2 = new L.Control.SimpleButton({
            click: function(evt) {                
                $("html, body").animate(
                {
                    scrollTop: targetElement.offset().top - 58,
                },
                "fast"
                );
            }
        });
        button2.addTo(map);
    </script>
{% endblock %}

