{% extends "master.html" %}
{% load filters %}
{% load static %}


{% block title %}
    Itinerary
{% endblock %}

{% block content %}

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css"> 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/monim67/django-flatpickr@2.0.0/src/django_flatpickr/static/django_flatpickr/js/django-flatpickr.js"></script>
    <script src="https://github.com/jerroydmoore/leaflet-button/blob/master/L.Control.Button.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
 
    <div class="container-padding">

        {% comment %} <img id="place-image" style="width:100px; height:100px; object-fit:cover; object-position:center;"> {% endcomment %}
        <form id="form_update_itinerary" method="post" style="margin-bottom:10px;margin-top:10px;">
            {% csrf_token %}
            <input id="id_user_survey" name="user_survey" value="{{ user_survey_id }}" hidden>
            <div class="nowrap-container">
                {{ form_update_itinerary.name }}
                <div class="buttons-right">
                    <button class=" btn-round-black" type="button" id="btn_itinerary_edit">
                        <i class="fas fa-pencil"></i>
                    </button>
                    <button class=" btn-round-success" type="submit" id="btn_itinerary_save" name="btn_itinerary_save" hidden>
                        <i class="fas fa-pencil" style="color:#198754;"></i>
                    </button>
                    <button id="btn_map" class="btn-round-black" type="button">
                        <i class="fas fa-map-location-dot" style="color:black;"></i> 
                    </button>
                    {% comment %} <button class="btn btn-outline-primary btn-activity-create btn-round-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                        <i class="fas fa-plus"></i> 
                    </button> {% endcomment %}
                </div>
            </div>
        </form>    
    </div>  

    <div class="slide active" id="map"></div>

    <div class="container-padding">
        <div class="nowrap-container">
            <div class="icon-input">
                <input id="h-osm-key" hidden/>
                <input id="h-osm-value" hidden/>
                <input id="h-house-number" hidden/>
                <input id="h-street" hidden/>
                <input id="h-city" hidden/>
                <input id="h-state" hidden/>
                <input id="h-postal-code" hidden/>
                <input id="h-country" hidden/>
                <input id="h-latitude" hidden/>
                <input id="h-longitude" hidden/>
                <input id="h-image-url" hidden/>
                <input id="h-description" hidden/>
                <input id="h-type" hidden/>
                <input class="form-control place-input" type="search" id="place-input" placeholder="Search a place" autocomplete="off"/>
                <button type="button" id="clear-btn">&times;</button>
                <i class="fas fa-magnifying-glass"></i> 
            </div>
            <div class="buttons-right">
                <button class="btn-round-success-color" type="button" id="btn_add_activity" style="display: none;">
                    <i class="fas fa-plus" style="color: white;"></i>
                </button>                    
            </div>            
        </div>
        
    <div id="suggestions"></div>
    </div>
    <div id="place-input-message" class="container-center" style="display: none;">
        <label class="text-danger">** Not saved yet. Click the add (+) button to save.</label>
    </div>
    {% comment %} <div id="search-container">
        <i class="fas fa-location-dot" style="margin-right:2px;"></i><input type="text" id="place-input" placeholder="Add a place" />
        <div id="suggestions"></div>
    </div> {% endcomment %}

    {% comment %} <a class="mt-3" href="{% url 'add_itinerary_destination' itinerary_id=itinerary_id %}"> Add Destination</a> |
    <a href="{% url 'update_itinerary' pk=itinerary_id %}"> Edit</a> {% endcomment %}
    {% if grouped_dates %}        
        <ul class="nav nav-pills scroll-container" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button id="btn-collapse-accordion-items" class="btn-collapse-accordion-items btn-round-gray-sm" type="button" data-bs-toggle="pill">
                    <i class="fas fa-compress"></i>
                </button>                
            </li>
            {% for date, activities in grouped_dates.items %}      
                <li class="nav-item" role="presentation">
                    <button class="btn-nav-link btn btn-dark btn-xs" id="pills-tab-{{ date|date:"m-d-Y" }}" data-bs-toggle="pill" data-bs-target="date-button-{{forloop.counter}}" type="button" role="tab" aria-controls="date-button-{{forloop.counter}}" aria-selected="false">
                        {{ date|date:"D" }} {{ date|date:"n/j" }}
                    </button>
                </li>
            {% endfor %}
      </ul>
      
        <div class="accordion next-line" id="accordion" style="margin-top:10px;">    
            {% for date, activities in grouped_dates.items %}   
                <div class="accordion-item">                    
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" id="accordion-button-{{ date|date:"m-d-Y" }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ date|date:"m-d-Y" }}" aria-expanded="true" aria-controls="collapse{{forloop.counter}}">
                            <div>{{ date }} - {{ date|date:"l" }}</div>&nbsp;
                            <span class="text-muted">(</span>
                            {% for i in activities|unique_countries:"country" %}
                                {% if not forloop.last %}
                                    <div class="text-muted"><em>{{ i }},&nbsp;</em></div>
                                {% else %}
                                    <div class="text-muted"><em>{{ i }}</em></div>
                                {% endif %}                            
                            {% endfor %}
                            <span class="text-muted">)</span>
                        </button>
                    </h2>
                    <div id="collapse_{{ date|date:"m-d-Y" }}" name="{{ date|date:"m-d-Y" }}" class="accordion-collapse collapse" data-bs-parent="#accordion">
                        <div class="">           
                            
                            {% comment %} <button class="btn btn-outline-primary btn-round-primary btn-activity-create btn-round activity-exising-date mt-2" name="{{ date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                <i class="fas fa-plus"></i> 
                            </button> {% endcomment %}
                            
                            
                            <div style="overflow-x:auto;">
                                {% for i in activities|dictsort:"start_time" %}
                                    {% for key, val in i|get_fields %}
                                        <input class="activity-update-input-{{i.id}}" name="id_{{ key }}" value="{{ val }}" hidden/>
                                    {% endfor %}
                                    <ul id="list">
                                        {% if forloop.first %}
                                            <li class="heading-item" id="item_heading_{{ i.id }}">
                                                {% if date in hotel_nights %}                                              
                                                    {% with hotel=hotel_nights|dict_key:date %}
                                                        {% if hotel %}    
                                                            {% for night in hotel_nights %}
                                                                {% if night == date %}
                                                                    {% for key, val in hotel|get_fields %}
                                                                        <input class="activity-update-input-{{hotel.id}}" name="id_{{ key }}" value="{{ val }}" hidden/>
                                                                    {% endfor %}
                                                                    <button id="btn_update_hotel" name="{{ hotel.id }}" class="btn-activity-update hotel-activity btn btn-success btn-xs activity-exising-date" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                                        Hotel <i class="fas fa-check" ></i>
                                                                    </button>
                                                                    <div class="hotel-info"><em>{{ hotel.place_name }} {{ hotels|nights_count:date }}
                                                                        
                                                                    </em></div>        
                                                                {% endif %}
                                                            {% endfor %}       
                                                        {% else %}
                                                            <button id="btn_add_hotel" class="btn-activity-create hotel-activity btn btn-danger btn-xs activity-exising-date" name="{{ i.start_date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                                Hotel <i class="fas fa-triangle-exclamation" style="color:yellow;"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endwith %}                                               
                                                {% endif %}
                                                    {% comment %}{% for hotel in hotels %}
                                                                 {% if hotel|is_within_stay:date %}   
                                                                  
                                                                        {% for key, val in hotel|get_fields %}
                                                                            <input class="activity-update-input-{{hotel.id}}" name="id_{{ key }}" value="{{ val }}" hidden/>
                                                                        {% endfor %}                                             
                                                                        <button id="btn_update_hotel" name="{{ hotel.id }}" class="btn-activity-update hotel-activity btn btn-success btn-xs activity-exising-date" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                                            Hotel <i class="fas fa-check" ></i>
                                                                        </button>
                                                                        <div class="hotel-info"><em>{{ hotel.place_name }} (Night {{ hotel.start_date|date_difference_plus_one:date }} of {{ hotel.start_date|date_difference:hotel.end_date }})</em></div>
                                                                        {% with added_dates=added_dates|add:date %}
                                                                        <div class="hotel-info"><em>  {{ added_dates }} </em></div>
                                                                        {% endwith %}
                                                                {% else %}
                                                                    <button id="btn_add_hotel" class="btn-activity-create hotel-activity btn btn-danger btn-xs activity-exising-date" name="{{ i.start_date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                                        Hotel <i class="fas fa-triangle-exclamation" style="color:yellow;"></i>
                                                                    </button>
                                                                {% endif %} 
                                                        {% endfor %}
                                                    
                                               {% else %}
                                                    <button id="btn_add_hotel" class="btn-activity-create hotel-activity btn btn-danger btn-xs activity-exising-date" name="{{ i.start_date|date:"m-d-Y" }}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                        Hotel <i class="fas fa-triangle-exclamation" style="color:yellow;"></i>
                                                    </button> 
                                                {% endif %}  {% endcomment %}   
                                            </li>
                                        {% endif %}
                                        <li class="swipe-item" id="swipe_item_{{ i.id }}" name="{{ i.place_name }}">
                                            <div class="item-container">
                                                <div class="item-left-up fw-bold fs-6">{{ i.start_time|date:"g:iA"|lower }}</div> &nbsp;
                                                <div class="item-centered">
                                                    {% if i.osm_key %} 
                                                        {% if i.osm_key == 'tourism' %}                                                         
                                                            <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i>  
                                                        {% else %}
                                                            <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i>  
                                                        {% endif %}
                                                    {% else %}
                                                        <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i> 
                                                    {% endif %}
                                                </div> &nbsp;
                                                <div class="item-left">
                                                    <a class="btn-activity-update" style="color: blue;" name="{{i.id}}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                        {{ i.place_name }}  
                                                    </a>
                                                </div>
                                                <div class="item-right">
                                                    {% if i.image_url %}
                                                        <img id="place-image-{{ i.id }}" class="item-image" alt="{{ i.place_name }}" src="{{ i.image_url }}">
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <button class="delete-btn">Delete</button>
                                        </li>
                                        <li class="transport-item" id="transport_item_{{ i.id }}">
                                            <button class="btn btn-outline-pill btn-sm"> 
                                                <i class="fas fa-person-walking" style="color:gray; margin-left:3px;"></i> &nbsp;
                                                <i class="fas fa-caret-down" style="color:gray; size: 5px;"></i> 

                                            </button>
                                            
                                            <button class="btn btn-outline-pill-right btn-sm options-ellipsis" name="{{i.id}}">
                                                <i class="fas fa-ellipsis" style="color:gray;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight_Directions" aria-controls="offcanvasRight_Directions"></i> 
                                            </button>
                                        </li>
                                    </ul>
                                {% endfor %}
                            </div>
                           

                            {% comment %} <div class="next-line" style="overflow-x:auto;">
                                <table class="">
                                    <thead class="table-head">
                                        <th>Time</th>
                                        <th></th>
                                        <th class="text-ellipsis">Activity</th>
                                        <th class="narrow-hidden td-center">Booked</th>
                                        <th class="narrow-hidden td-center">Paid</th>
                                        <th class="right-cell"></th>
                                    </thead>
                                    <tbody>
                                        {% for i in activities|dictsort:"start_time" %}
                                            {% for key, val in i|get_fields %}
                                                <input class="activity-update-input-{{i.id}}" name="id_{{ key }}" value="{{ val }}" hidden/>
                                            {% endfor %}
                                            <tr> 
                                                        <td class="time-highlight fit-text-cell">{{ i.start_time|date:"g:i A" }}</td>

                                                        <td class="icon-cell">
                                                            {% if i.osm_key %} 
                                                                {% if i.osm_key == 'tourism' %} 
                                                                    <i class="fas fa-binoculars" style="text-shadow: 0px 0px 3px black; color: white;"></i>                                                               
                                                                {% endif %}
                                                            {% endif %}
                                                        </td>

                                                        <td class="text-ellipsis">
                                                            <a class="btn-activity-update" style="color: blue;" name="{{i.id}}" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                                {{ i.place_name }}  
                                                            </a>
                                                        </td>

                                                        <td class="td-center narrow-hidden right-cell">
                                                            {% if i.booking_required %} 
                                                                {% if i.is_booked %}
                                                                    <i class="bi bi-check-circle" style="color:green;"></i> 
                                                                {% else %}
                                                                    <i class="bi bi-x-circle-fill" style="color:red;"></i> 
                                                                {% endif %}
                                                            {% else %}
                                                                {% if i.is_booked %}
                                                                    <i class="bi bi-check-circle" style="color:green;"></i> 
                                                                {% endif %}
                                                            {% endif %}
                                                        </td>

                                                        <td class="td-center narrow-hidden right-cell">
                                                            {% if i.pre_payment_required %} 
                                                                {% if i.is_paid %} 
                                                                    <i class="bi bi-check-circle" style="color:green;"></i> 
                                                                {% else %}                                                                
                                                                    <i class="bi bi-x-circle-fill" style="color:red;"></i> 
                                                                {% endif %}
                                                            {% else %}
                                                                {% if i.is_paid %} 
                                                                    <i class="bi bi-check-circle" style="color:green;"></i> 
                                                                {% endif %}
                                                            {% endif %}
                                                        </td>

                                                        <td class="td-center right-cell">
                                                            <img id="place-image-{{ i.id }}" class="item-image" alt="{{ i.place_name }}" src="{{ i.image_url }}">
                                                        </td>
                                            </tr>
                                            <tr>
                                                <td colspan="7" style="text-align: center;">
                                                    <button class="btn btn-outline-pill btn-sm"> 
                                                        <i class="fas fa-person-walking" style="color:gray; margin-left:3px;"></i> &nbsp;
                                                        <i class="fas fa-caret-down" style="color:gray; size: 5px;"></i> 
        
                                                    </button>
                                                    
                                                    <button class="btn btn-outline-pill-right btn-sm options-ellipsis" name="{{i.id}}">
                                                        <i class="fas fa-ellipsis" style="color:gray;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight_Directions" aria-controls="offcanvasRight_Directions"></i> 
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}                                            
                                    </tbody>
                                </table>
                            </div>  {% endcomment %}
                        </div> 
                    </div>
                </div>    
            {% endfor %}
        </div>  

    {% else %}
    <div class="accordion mt-2 container-padding">There are no destinations on this itinerary.</div>
    {% endif %}

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel">Add New Activity</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" style="margin-top:-20px;">
            <form method="post" name="form_activity" >
                {% csrf_token %} 
                {{ form.media }}   
                {% comment %} {{ form.as_p }} {% endcomment %}
                
                {% for field in form %}
                    {% if not field.is_hidden %}
                        {% if field.name == 'house_number' %}
                            <label style="margin-bottom: -10px;">Address:</label>
                            <div class="accordion" id="addressAccordion" style="margin-top:10px;">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading_address">
                                        <button class="accordion-button collapsed accordion-button-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_address" aria-expanded="false" aria-controls="collapse_address">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </button>
                                    </h2>
                                    <div id="collapse_address" class="accordion-collapse collapse" aria-labelledby="heading_address" data-bs-parent="addressAccordion">
                                        <div class="accordion-body" style="margin-top:-10px;">
                                            {{ field.label_tag }}
                                            {{ field }}
                                            {% if field.errors %}
                                                <div class="errorlist">
                                                    {{ field.errors }}
                                                </div>
                                            {% endif %}
                        {% elif field.name == 'start_date' %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% elif field.name in address_field_list %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="errorlist">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% else %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
                {% comment %} {% include 'itinerary_item.html' %} {% endcomment %}

                <input id="id_itinerary" name="itinerary" value="{{ itinerary_id }}" hidden>
                <div class="button-container">
                    <button name="form_submit" class="btn btn-success btn-sm" type="submit" style="width:100%;">Save</button>
                        <i id="id_delete_activity" class="fas fa-trash-can delete-icon"></i> 
                </div>
            </form>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight_Directions" aria-labelledby="offcanvasRightLabel_Directions">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel_Directions">Options:</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <button class="open-map btn btn-outline-primary" type="button">
                Google Maps
            </button>
            <button class="open-google btn btn-outline-primary" type="button">
                Google Search
            </button>
        </div>
    </div>    

    <div id="scroll-up">
        <i class="fa-solid fa-angles-up"></i>
    </div>

    <div id="divImageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="idImageModal">
        <div id="caption"></div>
    </div>

    <!-- Modal Confirmation -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to delete this item?</p>
            <button class="btn btn-danger" id="confirm-delete">Yes, Delete</button>
            <button class="btn btn-secondary" id="cancel-delete">Cancel</button>
        </div>
    </div>

    {% comment %} <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight_Destination" aria-labelledby="offcanvasRightLabel_Destination">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel_Destination">Add New Destination</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form method="post" class="small-form-width">
                {% csrf_token %}

                <label>Country:</label>

                <div>
                    <label><input type="radio" id="existing" name="country_selection" value="existing" checked /> Existing</label>
                </div>
                <div>
                    <label><input type="radio" id="new" name="country_selection" value="new" /> New</label>
                </div>

                {{ form_destination.media }}
                {{ form_destination.as_p }}
                <input id="id_itinerary" name="itinerary" value="{{ itinerary_id }}" hidden>
                
                <button class="btn btn-success btn-sm" type="submit">Add</button>
                    </form>
                </div>
    </div> {% endcomment %}

    <script>      

        $(window).scroll(function() {
            if($(this).scrollTop() != 0) {
                $('#scroll-up').fadeIn(); 
            } else {
                $('#scroll-up').fadeOut();
            }
        });

        $('#scroll-up').click(function() {
            $('body,html').animate({scrollTop:0},"fast");
        });  

        var offcanvas = new bootstrap.Offcanvas($('#offcanvasRight'));

        // const markerIcon = L.icon({
        //     iconUrl: '/static/markers/marker-icon-black.png',
        //     shadowUrl: '/static/markers/marker-shadow.png',
        //     iconSize: [25, 41],
        //     iconAnchor: [12, 41],
        //     popupAnchor: [1, -34],
        //     shadowSize: [41, 41]
        // })
        var map = L.map('map');
        var markers = [];
        L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: ' <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);              

        var bounds = L.latLngBounds(); 

        var locations = [];
        {% for date, activities in grouped_dates.items %}
            {% for i in activities|dictsort:"start_time" %}
                locations.push(["{{ i.city }}", "{{ i.postal_code }}", "{{ i.state }}", "{{ i.country }}", "{{ i.place_name }}", "{{ i.latitude }}", "{{ i.longitude }}", "{{ i.id }}", "{{ i.image_url }}", "{{ date|date:'m-d-Y' }}"]);
                //console.log("{{ i.id }}");
            {% endfor %}
        {% endfor %}
        
        var all_string = '';
        for (var i = 0; i < locations.length; i++) {

            var name = locations[i][4].replace(/\s/g, "+");
            var city = locations[i][0].replace(/\s/g, "+");
            var city_comma = '';
            var state = locations[i][2].replace(/\s/g, "+");
            var state_comma = '';
            var zip = locations[i][1].replace(/\s/g, "+");
            var country = locations[i][3].replace(/\s/g, "+");

            if (city.trim() != "") {
                city_comma = city + ',';
            }
            if (city.trim() === "None") {
                city_comma = '';
            }
            if (state.trim() != "") {
                state_comma = state + ',';
            }
            if (state.trim() === "None") {
                state_comma = '';
            }
            var fullAddress = `${name},+${city_comma},+${state_comma}+${zip}`;
            
            if (locations[i][5] != 'None' && locations[i][5] !== null && locations[i][5] !== undefined) {
                bounds.extend(L.latLng([locations[i][5], locations[i][6]])); 
            }

            var color = 'blue';

            const dateString = locations[i][9]; // MM-DD-YYYY format
            const parts = dateString.split("-");
            const date = new Date(parts[2], parts[0] - 1, parts[1]);
            var intDay = date.getDay();

            switch(intDay) {
                case 0:
                    color = 'violet';    
                    break;
                case 1:
                    color = 'gold';    
                    break;
                case 2:
                    color = 'blue';    
                    break;
                case 3:
                    color = 'grey';    
                    break;
                case 4:
                    color = 'red';    
                    break;
                case 5:
                    color = 'green'; 
                    break;
                case 6:
                    color = 'orange'; 
                    break;
                default:
                    color = 'blue'; 
                    // code block
            }

            if (locations[i][5] != 'None' && locations[i][5] !== null && locations[i][5] !== undefined) {
                marker = new L.marker([locations[i][5], locations[i][6]], 
                {
                     icon: L.icon({
                            iconUrl: `/static/markers/marker-icon-${color}.png`,
                            shadowUrl: '/static/markers/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                    }), 
                     name: name
                }) //{draggable:'true'}
            .bindPopup(`<b>${locations[i][4]}</b>
                <br>${city_comma} ${state_comma} ${locations[i][3]}
                <br><a href="#">Edit</a> | <a href="https://www.google.com/maps/dir/?api=1&destination=${fullAddress}" target="_blank">Directions</a>
                `)
            .addTo(map);
            markers.push(marker); 
            }
           

            //marker.on("dragend", function(e) {
            //    var marker = e.target;
            //    var position = marker.getLatLng();
            //    map.panTo(new L.LatLng(position.lat, position.lng));
            //    console.log(position.lat);
             //   console.log(position.lng);

            //    //TO DO: UPDATE COORDINATES IN DB

            //});
        }

        try{
            var center = bounds.getCenter();
            map.setView(center, 10);
            map.fitBounds(bounds);
        }
        catch(e) {
            var center = {{ map_center }}; 
            console.log(center);
            map.setView([37.092, -95.7129], 3);
        }
    
        //function addIfNotExist(array, item, fieldIndex) {
        //    // Check if the item exists in the array based on the specified field
        //   findCountry = item[fieldIndex];
        //   const countryExists = array.some(country => country === findCountry);
        //    // If the item doesn't exist, add it to the array
        //    if (countryExists == false) {
        //        array.push(item[fieldIndex]);
        //    }

        //    return array;
        // }

        let searchMarker; // To store the marker

        // Search and handle results
        $('#place-input').on('input', function () {
            console.log('entered');
            const query = $(this).val();
            if (query.length < 3) {
                $('#suggestions').empty();
                return;
            }

        // Photon API URL
        const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`;


        $.getJSON(url, function (data) {
            // console.log('entered');
            const features = data.features;
            $('#suggestions').empty(); // Clear old suggestions

            if (features.length === 0) {
            $('#suggestions').append('<div>No results found.</div>');
            return;
            }
            
            featuresAdded = [];

            features.forEach(function (feature) {
                if (placeInputIsEmpty) {
                    return false;
                }
                var name = feature.properties.name || 'Unnamed location';

                var house_number = '';
                try {
                    house_number = feature.properties.housenumber || '';
                }
                catch (e)
                {

                }
                var street = feature.properties.street || '';
                var city = feature.properties.city || '';
                var city_comma = '';
                var state = feature.properties.state || '';
                var state_comma = '';
                var postal_code = feature.properties.postcode || '';
                var country = feature.properties.country || '';
                let itemFlagUrl = '';

                if (city.trim() != "") {
                    city_comma = city + ',';
                }
                if (state.trim() != "") {
                    state_comma = state + ',';
                }

                var osm_key  = '';
                try {
                    osm_key = feature.properties.osm_key || '';
                }
                catch (e)
                {

                }
                var osm_value  = '';
                try {
                    osm_value = feature.properties.osm_value || '';
                }
                catch (e)
                {

                }
                
                var latitude = feature.geometry.coordinates[1];
                var longitude = feature.geometry.coordinates[0];
                
                //const fullAddress = $(`${name}, ${city}, ${country}`);

                //console.log(fullAddress);
                //if (featuresAdded.includes(fullAddress))
                //{
                //    return true;
               //}

                const suggestion = $(`<div class="suggestion"><i class="fas fa-location-dot" ></i> ${name}, ${city_comma} ${state_comma} ${country}</div>`);
                
                // On click, update the map and input field
                suggestion.on('click', function () {
                    
                    const wikiUrl = "https://en.wikipedia.org/w/api.php";
                    const flagUrl = "https://commons.wikimedia.org/w/api.php";

                    const emUsr = "coolralph_s";
                    const emDmn = "hotmail.com"
                    const request = `TailwindTravel (${emUsr}@${emDmn})`;     
                    
                    var h_image_url = document.getElementById('h-image-url');

                    let titleSearch = `File:Flag of ${country}.svg`;

                    $.ajax({
                        url: wikiUrl,
                        data: {
                            action: "query",
                            format: "json",
                            origin: "*",
                            titles: `${encodeURIComponent(name)}`,
                            prop: "pageimages",
                            pithumbsize: "500"
                        },
                        dataType: "jsonp",
                        method: 'GET',
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('User-Agent', request);
                        },
                        success: function(response) {
                            const pages = response.query.pages;
                            for (const pageId in pages) {
                                const page = pages[pageId];
                                if (page.thumbnail) {
                                    const imageUrl = page.thumbnail.source;
                                    h_image_url.value = imageUrl;
                                } else {
                                    try {
                                        
                                        //second ajax
                                        $.ajax({
                                        url: flagUrl,
                                        data: {
                                            action: "query",
                                            format: "json",
                                            origin: "*",
                                            titles: titleSearch,
                                            prop: "imageinfo",
                                            iiprop: "url"
                                        },
                                        dataType: "jsonp",
                                        beforeSend: function(xhr) {
                                            xhr.setRequestHeader('User-Agent', request);
                                        },
                                        success: function(data) {      
                                            let flagPages = data.query.pages;
                                            
                                            if (flagPages) {
                                                let flagUrl = null;

                                                // Loop through results to find the most relevant flag image
                                                $.each(flagPages, function(index, flagPage) {
                                                    if (flagPage.imageinfo) {
                                                        flagUrl = flagPage.imageinfo[0].url;
                                                        
                                                        return false; // Exit loop after getting the first valid image
                                                    }
                                                });

                                                if (flagUrl) {
                                                    h_image_url.value = flagUrl;
                                                } else {
                                                    console.log("Flag not found.");
                                                }
                                            }
                                        },
                                        error: function(err) {
                                            console.error('Error fetching data:', err);
                                        }
                                        
                                    });

                                    }
                                    catch (ex) {
                                        console.log('No flag found for this place either.');
                                    }
                                }
                            }
                        },
                        error: function(err) {
                            console.error('Error fetching data:', err);
                        }
                    });

                    
                    //console.log(itemFlagUrl);
                    //console.log(feature);
                    //mapDiv.classList.toggle('active');
                    //$('#place-input').val(`${name}, ${city} ${country}`);
                    $('#suggestions').empty(); // Clear suggestions
    
                    //fullValue = `${name}, ${city} ${state} ${country}`;
                    // Center the map and add a marker
                    if (searchMarker) map.removeLayer(searchMarker);
                    map.setView([latitude, longitude], 15);
                    searchMarker = L.marker([latitude, longitude], {name: name}).addTo(map)
                        .bindPopup(`<b>${name}</b><br>${city_comma} ${state_comma} ${country}`)
                        .openPopup();

                    bounds.extend(L.latLng([latitude, longitude])); 
                    //markers.push(searchMarker);
                    var h_place_name = document.getElementById('place-input');
                    var h_description = document.getElementById('h-description');
                    var h_osm_key = document.getElementById('h-osm-key');
                    var h_osm_value = document.getElementById('h-osm-value');
                    var h_house_number = document.getElementById('h-house-number');
                    var h_street = document.getElementById('h-street');
                    var h_city = document.getElementById('h-city');
                    var h_state = document.getElementById('h-state');
                    var h_postal_code = document.getElementById('h-postal-code');
                    var h_country = document.getElementById('h-country');
                    var h_latitude = document.getElementById('h-latitude');
                    var h_longitude = document.getElementById('h-longitude');
                    var h_type = document.getElementById('h-type');
                    //var h_image_url = document.getElementById('h-image-url');
                    h_place_name.value = name;
                    h_place_name.focus();
                    h_osm_key.value = osm_key;
                    h_osm_value.value = osm_value;
                    h_house_number.value = house_number;
                    h_street.value = street;
                    h_city.value = city;
                    h_state.value = state;
                    h_postal_code.value = postal_code;
                    h_country.value = country;
                    h_latitude.value = latitude;
                    h_longitude.value = longitude;
                    h_description = "";
                    //h_image_url = itemFlagUrl;
                    $("#place-input-message").show();
                    //offcanvas.show();                    
                });                

                let exists = false;
                featuresAdded.forEach(function (i) {
                    if (i === `${name}, ${city} ${country}`)
                    {
                        exists = true;
                    }
                });

                if (!exists)
                {
                    $('#suggestions').append(suggestion);
                    featuresAdded.push(`${name}, ${city} ${country}`);
                }

                });
            });
        });

        let config_start_time = {
            altInput: true,
            enableTime: true,
            noCalendar: true,
            time_24hr: false,
            dateFormat: "H:i:S",
            defaultDate: "12:00"
        }
        let config_end_time = {
            altInput: true,
            enableTime: true,
            noCalendar: true,
            time_24hr: false,
            dateFormat: "H:i:S",
            defaultDate: "13:00"
        }
        //initialize time inputs
        let st = flatpickr("#id_start_time", config_start_time);
        let et = flatpickr("#id_end_time", config_end_time); 

        let activity_array = [];

        $( function() {
            setTimeout(function () {
                window.dispatchEvent(new Event('resize'));
            }, 1000);
            $.ajaxSetup({
            headers: { "X-CSRFToken": '{{csrf_token}}' }
            });
            try {      
                //let inputString = $("#id_activity_array").val();
                //activity_array = JSON.parse(inputString);

                //initialize date pickers
                $( "#id_start_date" ).datepicker({
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true
                });
                $( "#id_end_date" ).datepicker({
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true
                });

                //make sure date is a real date and exists
                try {
                    //expand if passed
                    var expand_date = $("#id_expand_item").val();
                    $("#collapse_"+expand_date).collapse("show");  
                    var date = $("#collapse_"+expand_date).attr('name');

                    var parts = date.split('-');
                    var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
                    $('#id_start_date').datepicker("setDate", dateObj);
                    $('#id_end_date').datepicker("setDate", dateObj);
                }
                catch (error)
                {
                    $('#id_start_date').datepicker("setDate", "today");
                    $('#id_end_date').datepicker("setDate", "today");
                }

                //code for create activity
                //$("#id_country").hide();
                //$("#id_city").hide();
                //$("label[for='id_country']").css("margin-top", "10px");
                //$("label[for='id_city']").css("margin-top", "10px");
                //$("label[for='id_itinerary_destination']").css("margin-top", "10px");
                //$("label[for='id_country']").hide();                                                                                 
            }
            catch (error)
            {
                console.log(error)
            }
        } );
        $('#accordion').on('show.bs.collapse', function (e) {

            var date = e.target.getAttribute('name');

            bounds = L.latLngBounds(); 
            locations.forEach(function(location) {
                if (location[5] != null && location[5] != undefined && location[5] != 'None')
                {
                    if (location[9] == date)
                    {
                        bounds.extend(L.latLng([location[5], location[6]]));
                    }
                }
            });
            map.fitBounds(bounds);
            
            SetDatePickers(date);
            SetExpandItem(date);
        });      
        $('#accordion').on('hide.bs.collapse', function (e) { 
            var id = $(this).attr('id');
            var accordionButton = id.replace('accordion-button-', 'pills-tab-');
            var item = document.getElementById(accordionButton);
            item.classList.remove("active");
        });
        function SetAllBounds(){
            bounds = L.latLngBounds();
            // iterate through markers and set bounds
            
            locations.forEach(function(location) {
                if (location[5] != null && location[5] != undefined && location[5] != 'None')
                {
                    bounds.extend(L.latLng([location[5], location[6]]));
                }
            });
            map.fitBounds(bounds);
        }
        function SetDatePickers(date){
            var parts = date.split('-');
            var dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
            $('#id_start_date').datepicker("setDate", dateObj);
            $('#id_end_date').datepicker("setDate", dateObj);
        }
        function SetExpandItem(date){
            $("#id_expand_item").val(date);
        }
        $('input[type="radio"]').change(function() {
            var selectedValue = $(this).val();
            //console.log(selectedValue);
            if (selectedValue == 'existing')
            {
                $("#id_country").hide();
                $("#id_city").hide();
                $("label[for='id_country']").hide();
                $("label[for='id_city']").hide();
                //$("label[for='id_itinerary_destination']").show();
                //$("#id_itinerary_destination").show();
                //$("#id_itinerary_destination").prop('required',true);
                $("#id_country").prop('required',false);
                $("#id_city").prop('required',false);
            }
            else{
                $("#id_country").show();
                $("#id_city").show();
                $("label[for='id_country']").show();
                $("label[for='id_city']").show();
                //$("label[for='id_itinerary_destination']").hide();
                //$("#id_itinerary_destination").hide();
                //$("#id_itinerary_destination").prop('required',false);
                $("#id_country").prop('required',true);
                $("#id_city").prop('required',true);
            }            
        });
        $("#id_existing_countries").change(function() {
            var selectedValue = $(this).val(); 
            $("#id_country").val(selectedValue).change();   
        });

        $("#btn_itinerary_edit").click(function() {
            $(this).attr("hidden", true);       
            $("#btn_itinerary_save").removeAttr('hidden');

            $("#id_name").prop("disabled", false);
            $("#id_name").focus();
        });

        $("#form_update_itinerary").submit(function(event) {
            event.preventDefault(); // Prevent default form submission

            $.ajax({
                url: $(this).attr("action"),
                type: $(this).attr("method"),
                data: $(this).serialize(),
            success: function(response) {
                //console.log(response.message);
                $("#btn_itinerary_save").attr("hidden", true);       
                $("#btn_itinerary_edit").removeAttr('hidden');
                $("#id_name").prop("disabled", true);
            },
            error: function(error) {
                console.error("Error submitting form:", error);
            }
            });
        });

        $("input").on("focus", function() {
            var input = $(this);
            if (input.attr("id") == "id_name")
            {
                //console.log(input.attr("id"));
                var len = input.val().length;

                // Set timeout to allow the focus to take effect first
                setTimeout(function() {
                input[0].setSelectionRange(len, len);
                }, 0);
            }
        });

        $(".btn-activity-update").click(function() {
            console.log('hotel clicked too');
            var itinerary_item_id = $(this).attr('name');
            $("#id_operation").val('update');
            $("#offcanvasRightLabel").text("Update Activity");
            var inputs = $(".activity-update-input-" + itinerary_item_id);

            //set values
            for(var i = 0; i < inputs.length; i++){
                var val = $(inputs[i]).val();
                var name = $(inputs[i]).attr('name');

                if (val === 'None')
                {
                    val = '';
                }
                
                switch(name) {
                case "id_start_date":
                case "id_end_date":
                    var date_parts = val.split('-');
                    var newDateObj = new Date(date_parts[0], date_parts[1] - 1, date_parts[2]); 
                    $('#'+name).datepicker("setDate", newDateObj);
                    break;
                case "id_start_time":
                    config_start_time = {
                        altInput: true,
                        enableTime: true,
                        noCalendar: true,
                        time_24hr: false,
                        dateFormat: "H:i:S",
                        defaultDate: val
                    }

                    //initialize time inputs
                    st = flatpickr("#id_start_time", config_start_time);

                    break;
                case "id_end_time":        
                    // et.setDate(val);
                    config_end_time = {
                        altInput: true,
                        enableTime: true,
                        noCalendar: true,
                        time_24hr: false,
                        dateFormat: "H:i:S",
                        defaultDate: val
                    }

                    //initialize time inputs
                    st = flatpickr("#id_end_time", config_end_time);
                    break;
                case "id_is_skip":                    
                case "id_is_booked":
                case "id_booking_required":
                case "id_pre_payment_required":
                case "id_is_paid":
                    var isTrueSet = (val.toLowerCase() === 'true');
                    $("#"+name).prop('checked', isTrueSet);
                    break;
                case "id_id":
                    $("#id_delete_activity").attr('name',val);
                    //console.log(val);
                case "id_activity":
                    var selectedTypeId = $('#id_activity_type').find(":selected").val();
                    var select = $("#"+name);
                    select.empty();
                    $.each(activity_array, function(index, item) {                        
                        if (parseInt(item[0]) === parseInt(selectedTypeId)) {
                            select.append($("<option></option>")
                            .attr("value", item[1])
                            .text(item[2]));
                        }
                    });
                    select.val(val);
                    break;
                default:                   
                    $("#"+name).val(val);
                    break;
                }                
            }
        });
        $(".btn-activity-create").click(function() {
            console.log('create');
            if ($(this).hasClass("hotel-activity")){
                $("#offcanvasRightLabel").text("Add Hotel or Stay");
                $("#id_type").val('3');
                console.log($("#id_type").val());
            }
            else{
                $("#offcanvasRightLabel").text("Add New Activity");
                $("#id_type").val('4');
                console.log($("#id_type").val());
            }

            $("#id_operation").val('create');
            
            //empty activities
            $("#id_activity").empty();
            //deselect all selects
            $('select').each(function() {
                $(this).val(''); // Set the value to an empty string
            });
            //clear all updatable inputs
            $(".updatable:visible").each(function() {
                $(this).val("");
            });
            //unckeck all checkboxes
            $('input[type=checkbox]').each( 
                function (index, checkbox) { 
                if (index != 0) { 
                    checkbox.checked = false; 
                } 
            }); 
            //reinitialize dates/times
            config_start_time = {
                altInput: true,
                enableTime: true,
                noCalendar: true,
                time_24hr: false,
                dateFormat: "H:i:S",
                defaultDate: "15:00"
            }
            config_end_time = {
                altInput: true,
                enableTime: true,
                noCalendar: true,
                time_24hr: false,
                dateFormat: "H:i:S",
                defaultDate: "11:00"
            }

            //initialize time inputs
            st = flatpickr("#id_start_time", config_start_time);
            et = flatpickr("#id_end_time", config_end_time);

            if ($(this).hasClass("activity-exising-date")){
                var date = $(this).attr('name')
                var parts = date.split('-');
                console.log(parts);
                var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
                $('#id_start_date').datepicker("setDate", dateObj);
                if ($(this).hasClass("hotel-activity")){
                    dateObj.setDate(dateObj.getDate() + 1); 
                    $('#id_end_date').datepicker("setDate", dateObj);
                }
                else
                {
                    $('#id_end_date').datepicker("setDate", dateObj);
                }   
            }
            else
            {     
                $('#id_start_date').datepicker("setDate", "today");
                $('#id_end_date').datepicker("setDate", "today");
            }
        });
        $("#id_activity_type").change(function() {
            var selectedTypeId = $(this).val();
            var select = $("#id_activity");
            select.empty();
            $.each(activity_array, function(index, item) {                        
                if (parseInt(item[0]) === parseInt(selectedTypeId)) {
                    select.append($("<option></option>")
                        .attr("value", item[1])
                        .text(item[2]));
                }
            });
        });
        $('#id_start_date').change(function() {
            var selectedDate = $(this).val();
            var parts = selectedDate.split('/');
            var dateObj = new Date(parts[2], parts[0] - 1, parts[1]);
            $('#id_end_date').datepicker("setDate", dateObj);
        });

        var googleSearch = '';
        var directionsFullAddress = '';
        $(".options-ellipsis").click(function() {
            var itinerary_item_id = $(this).attr('name');
            var inputs = $(".activity-update-input-" + itinerary_item_id);

            var place = '';
            var city = '';
            var city_comma = '';
            var state = '';
            var state_comma = '';
            var zip = '';
            var country = '';

            //set values
            for(var i = 0; i < inputs.length; i++){
                var val = $(inputs[i]).val();
                var name = $(inputs[i]).attr('name');
                if (val === 'None')
                {
                    val = '';
                }
                
                switch(name) {
                case "id_place_name":
                    place = val;
                case "id_city":
                    city = val;
                    break;
                case "id_state":
                    state = val;
                    break;
                case "id_postal_code":
                    zip = val;
                    break;
                case "id_country":
                    country = val;
                    break;
                default:                   

                    break;
                }                
            }
            if (city.trim() != "") {
                city_comma = city + ',';
            }
            if (state.trim() != "") {
                state_comma = state + ',';
            }

            directionsFullAddress = `${place},+${city_comma},+${state_comma}+${zip}+${country}`;
            googleSearch = place;
        });

        $(".open-map").click(function() {
            //var street = "Zion Park Blvd.".replace(/\s/g, "+");
            //var city = "Springdale".replace(/\s/g, "+");
            //var state = "UT".replace(/\s/g, "+");
            //var zip = "84767";
            //var fullAddress = `${street},+${city},+${state}+${zip}`;
            // console.log(directionsFullAddress);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${directionsFullAddress}`, "_blank");
        });
        $(".open-google").click(function() {
            var encodedSearch = encodeURIComponent(googleSearch);
            window.open(`https://www.google.com/search?q=${encodedSearch}`, "_blank");
        });
        $("#id_remove_marker").click(function() {
            var name = searchMarker.options.name.replace("+", " ");
            map.removeLayer(searchMarker);
            
            locations = locations.filter(loc => loc[4] != name);

            SetAllBounds();

            //ajax delete from db if exists
            //close offcanvas
            offcanvas.hide();
        });
        const mapDiv = document.getElementById('map');
        $("#btn_map").click(function() {
            mapDiv.classList.toggle('active');
        });                              
        //$('input[type="search"]').on('search', function(e) {
        //    $('#suggestions').empty();
        //});
        let debounceTimeout;
        $('input[type="search"]').on('input', function() {
            if ($.trim($('#place-input').val()) != '') {
                placeInputIsEmpty = false;
                $("#btn_add_activity").show();
            }
            else {
                $("#btn_add_activity").hide();
            }
            checkAndClear();
        }).on('keyup', function(e) {
            if (e.key === 'Backspace' || e.keyCode === 8) {
                checkAndClear();
            }
            if (e.which === 13) {
                //enter was pressed
                $("#id_operation").val('create');
                setOffsetValues()
                offcanvas.show();
            }
        });
        let placeInputIsEmpty = false;
        function checkAndClear() {
            if ($.trim($('#place-input').val()) === '') {
                placeInputIsEmpty = true;
                $('#suggestions').empty();
            }
        }
        $('input[type="search"]').on('focus', function() {
            //$("html, body").animate({scrollTop:0}, 500);
        });
        $("#btn_add_activity").click(function() {
            $("#id_operation").val('create');
            $("#id_type").val(4);
            setOffsetValues();
            offcanvas.show();
        });
        $("#btn_add_hotel").click(function() {
            $("#id_operation").val('create');
            $("#id_type").val(3);
            // setOffsetValues();
            offcanvas.show();
        });
        function setOffsetValues() {
            $("#id_place_name").val($('#place-input').val());
            $("#id_osm_key").val($('#h-osm-key').val());
            $("#id_osm_value").val($('#h-osm-value').val());
            $("#id_house_number").val($('#h-house-number').val());
            $("#id_street").val($('#h-street').val());
            $("#id_city").val($('#h-city').val());
            $("#id_state").val($('#h-state').val());
            $("#id_postal_code").val($('#h-postal-code').val());
            $("#id_country").val($('#h-country').val());
            $("#id_latitude").val($('#h-latitude').val());
            $("#id_longitude").val($('#h-longitude').val());
            $("#id_image_url").val($('#h-image-url').val());
            $("#id_description").val($('#h-description').val());
        }
        var myOffcanvas = document.getElementById('offcanvasRight');
        myOffcanvas.addEventListener('hidden.bs.offcanvas', function () {

        });        

        const searchInput = document.getElementById('place-input');
        const clearButton = document.getElementById('clear-btn');

        // Show/hide clear button based on input value
        searchInput.addEventListener('input', () => {
            clearButton.style.display = searchInput.value ? 'block' : 'none';
        });

        // Clear the input when the clear button is clicked
        clearButton.addEventListener('click', () => {
            var name = searchInput.value.toLowerCase();

            searchInput.value = '';
            clearButton.style.display = 'none';
            $('#suggestions').empty();
            $("#place-input-message").hide();

            map.removeLayer(searchMarker);            
            locations = locations.filter(loc => loc[4].toLowerCase() != name);

            SetAllBounds();

            searchInput.focus(); // Optional: return focus to the input
        });

        var modal = document.getElementById("divImageModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var modalImg = document.getElementById("idImageModal");
        var captionText = document.getElementById("caption");
        $(".item-image").click(function() {
            var src = $(this).attr("src");
            modal.style.display = "block";
            modalImg.src = src;
            captionText.innerHTML = this.alt;
        });
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
            modal.style.display = "none";
        }

        $("#divImageModal").click(function() {
            modal.style.display = "none";
        });

        L.Control.SimpleButton = L.Control.extend({
            _className: 'leaflet-control-simplebutton',
            options: {
                faIcon: 'fa-crosshairs',
                position: 'topright',
                text: "",
                id: "",
                click: function(){}
            },
            initialize: function (options) {
                L.setOptions(this, options);
            },
            onAdd: function (map) {
                this._map = map;
                this._container = L.DomUtil.create('div',this._className);
                this._buildButton();
                return this._container;
            },
            onRemove: function (map) {
                L.DomEvent.off(this._link, 'click', this.options.click);
            },
            _buildButton: function(){
                this._link = L.DomUtil.create('a','simplebutton-action',this._container);
                this._link.href = "#";
                if(this.options.id) {
                this._link.id = this.options.id;
                }
                if(this.options.text) {
                this._link.innerHTML = this.options.text;
                }else{
                L.DomUtil.create('i','fa ' + this.options.faIcon, this._link);
                }
                L.DomEvent.on(this._link, 'click', this.options.click, this._link);
            }
        });

        L.control.simplebutton = function (options) {
            return new L.Control.SimpleButton(options);
        };

        var button = new L.Control.SimpleButton({
            click: function(evt) {
                if (markers.length > 0) {
                    SetAllBounds();
                }
            }
        });
        button.addTo(map);

        L.Control.SimpleButton = L.Control.extend({
            _className: 'leaflet-control-simplebutton',
            options: {
                faIcon: 'fa-angles-down',
                position: 'topright',
                text: "",
                id: "",
                click: function(){}
            },
            initialize: function (options) {
                L.setOptions(this, options);
            },
            onAdd: function (map) {
                this._map = map;
                this._container = L.DomUtil.create('div',this._className);
                this._buildButton();
                return this._container;
            },
            onRemove: function (map) {
                L.DomEvent.off(this._link, 'click', this.options.click);
            },
            _buildButton: function(){
                this._link = L.DomUtil.create('a','simplebutton-action',this._container);
                this._link.href = "#";
                if(this.options.id) {
                this._link.id = this.options.id;
                }
                if(this.options.text) {
                this._link.innerHTML = this.options.text;
                }else{
                L.DomUtil.create('i','fa ' + this.options.faIcon, this._link);
                }
                L.DomEvent.on(this._link, 'click', this.options.click, this._link);
            }
        });

        L.control.simplebutton = function (options) {
            return new L.Control.SimpleButton(options);
        };

        const targetElement = $("#place-input");
        var button2 = new L.Control.SimpleButton({
            click: function(evt) {                
                $("html, body").animate(
                {
                    scrollTop: targetElement.offset().top - 58,
                },
                "fast"
                );
            }
        });
        button2.addTo(map);

        // $("#id_delete_activity").click(function() {            
        //     const modal = document.getElementById("delete-modal");
        //     offcanvas.hide();
        //     modal.style.display = "flex";
        //     // Cancel delete action
        //     confDeleteBtn.addEventListener("click", () => {
        //         modal.style.display = "none";
        //         itemToDelete.classList.remove("swiped");
        //     });
        // });

        document.addEventListener("DOMContentLoaded", () => {
            let activeItem = null; // Tracks currently swiped item
            let itemToDelete = null; // Tracks item to be deleted
            let isMouseDown = false; // Tracks if the mouse is pressed
            let isDragging = false; //  Tracks if dragging happened
            let deleteIconClicked = false;
            let idToDelete = null;

            const modal = document.getElementById("delete-modal");
            const confirmDeleteBtn = document.getElementById("confirm-delete");
            const cancelDeleteBtn = document.getElementById("cancel-delete");
            
            document.querySelectorAll(".delete-icon").forEach(item => {
                item.addEventListener("click", (e) => {
                    idToDelete = $("#id_delete_activity").attr('name');
                    console.log(idToDelete);
                    deleteIconClicked = true;
                    offcanvas.hide();
                    modal.style.display = "flex";
                });
            });

            document.querySelectorAll(".swipe-item").forEach(item => {
                let startX = 0;

                // Touch events for mobile
                item.addEventListener("touchstart", (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = false;
                });

                item.addEventListener("touchmove", (e) => {
                    let diffX = e.touches[0].clientX - startX;
                    if (diffX < -30) { // Swipe left threshold
                        closeOtherItems();
                        item.classList.add("swiped");
                        activeItem = item;
                        isDragging = true;
                    }
                    if (diffX > 30) { // Swipe right threshold
                        item.classList.remove("swiped");
                    }
                });

                // Desktop: Start tracking on mouse down
                item.addEventListener("mousedown", (e) => {
                    startX = e.clientX;
                    isMouseDown = true;
                    isDragging = false; //  Reset dragging flag
                });

                item.addEventListener("mousemove", (e) => {
                    if (!isMouseDown) return; //  Prevent hover activation

                    let diffX = e.clientX - startX;
                    if (diffX < -30) { // Swipe left threshold
                        closeOtherItems();
                        item.classList.add("swiped");
                        activeItem = item;
                        isDragging = true; //  Mark as dragged
                    }
                    if (diffX > 30) { // Swipe right threshold
                        item.classList.remove("swiped");
                    }
                });

                //  Reset flags when mouse button is released
                document.addEventListener("mouseup", () => {
                    isMouseDown = false;
                });

                //  Only close swipe if there was NO dragging
                item.addEventListener("click", (e) => {
                    if (!isDragging && activeItem === item) {
                        item.classList.remove("swiped");
                        activeItem = null;
                    }
                });

                // Show delete confirmation modal
                item.querySelector(".delete-btn").addEventListener("click", (e) => {
                    e.stopPropagation(); // Prevent hiding when clicking delete
                    itemToDelete = item;
                    modal.style.display = "flex";
                });
            });

            // Confirm delete action
            confirmDeleteBtn.addEventListener("click", () => {
                if (!deleteIconClicked) {
                    if (itemToDelete) {
                        let id = $(itemToDelete).attr("id").replace("swipe_item_", "");
                        let name = $(itemToDelete).attr("name").replace(" ", "+");
                        let name_plus = name.replace(" ", "+");

                        // Ajax request
                        $.ajax({
                            url: "/delete_itinerary_activity/", // Replace with your Django view URL
                            type: "POST",
                            data: {
                                "id": id,
                                "csrfmiddlewaretoken": "{{ csrf_token }}" // Important for CSRF protection
                            },
                            success: function(response) {
                                itemToDelete.remove();
                                $("#transport_item_" + id).remove();

                                markers.forEach(function(marker) {
                                    if (marker.options.name && marker.options.name == name_plus) {
                                        map.removeLayer(marker);
                                    }
                                });

                                locations = locations.filter(loc => loc[4] != name);
                                SetAllBounds();

                                itemToDelete = null;
                            },
                            error: function(error) {
                                console.error(error);
                            }
                        });
                    }
                }
                else
                {
                    $("#id_operation").val('delete');
                    let formName = 'form_activity';
                    const form = $(`form[name='${formName}']`);

                    if (form.length) {
                        form.submit();
                    } else {
                        console.error(`Form with name '${formName}' not found.`);
                    }
                    // let id = idToDelete;
                    // // Ajax request
                    // $.ajax({
                    //         url: "/delete_itinerary_activity/", // Replace with your Django view URL
                    //         type: "POST",
                    //         data: {
                    //             "id": id,
                    //             "csrfmiddlewaretoken": "{{ csrf_token }}" // Important for CSRF protection
                    //         },
                    //         success: function(response) {
                    //             //itemToDelete.remove();
                    //             //$("#transport_item_" + id).remove();
                                
                    //             // markers.forEach(function(marker) {
                    //             //     if (marker.options.name && marker.options.name == name_plus) {
                    //             //         map.removeLayer(marker);
                    //             //     }
                    //             // });

                    //             // locations = locations.filter(loc => loc[4] != name);
                    //             // SetAllBounds();

                    //             // itemToDelete = null;
                    //         },
                    //         error: function(error) {
                    //             console.error(error);
                    //         }
                    //     });
                }
                modal.style.display = "none";
            });

            // Cancel delete action
            cancelDeleteBtn.addEventListener("click", () => {
                if (!deleteIconClicked) {
                    itemToDelete.classList.remove("swiped");
                }
                modal.style.display = "none";
                deleteIconClicked = false;
            });

            // Close swipe when clicking outside
            document.addEventListener("click", (e) => {
                if (activeItem && !activeItem.contains(e.target) && !modal.contains(e.target)) {
                    activeItem.classList.remove("swiped");
                    activeItem = null;
                }
            });

            function closeOtherItems() {
                document.querySelectorAll(".swipe-item").forEach(el => {
                    if (el !== activeItem) el.classList.remove("swiped");
                });
            }
        });

        $(".btn-nav-link").on("click", function() {
            let classesBeforeClick = $(this).attr("class"); // Get class before modifying
            console.log("Classes before click:", classesBeforeClick);
        });
        $(".btn-nav-link").click(function() {        
            if ($(this).hasClass("active")) {
                console.log('has active');
            }
            else{

            }

            var date = $(this).attr('id');           
            expand_date = date.replace('pills-tab-', '');
            $("#collapse_"+expand_date).collapse("show");
        });
        $(".btn-collapse-accordion-items").click(function() {
            $(".accordion-collapse").collapse("hide");
            SetAllBounds();
        });

        $(".accordion-button").click(function() {
            if ($(this).hasClass("collapsed")) {
                try
                {
                var id = $(this).attr('id');
                var newId = id.replace('accordion-button-', 'pills-tab-');
                var element = document.getElementById(newId)
                element.classList.remove("active");
                }
                catch(ex)
                {
                    console.log('no id');
                }
           }
           else
           {
                //get all class
                try
                {
                    
                    document.querySelectorAll(".btn-nav-link").forEach(element => {
                        element.classList.remove("active");
                    });
                    var id = $(this).attr('id');
                    console.log(id);
                    var newId = id.replace('accordion-button-', 'pills-tab-');
                    var element = document.getElementById(newId)
                    element.classList.add("active");
                }
                catch(ex)
                {
                    console.log('no id');
                }
           }
        });
    </script>
{% endblock %}

